<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GRITLab Africa Bootcamp - Admin Dashboard</title>
  <link rel="icon" type="image/png" href="assets/images/logo.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* Header and Footer Styles (copied exactly from reference) */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Poppins', sans-serif;
      color: #000;
    }

    .container {
      width: 90%;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 15px;
    }

    a {
      text-decoration: none;
      color: #000;
    }

    ul {
      list-style: none;
    }

    header {
      position: absolute;
      width: 100%;
      top: 0;
      left: 0;
      padding: 20px 0;
      z-index: 1000;
      background-color: #fff;
    }

    .logo {
      color: #000;
      font-weight: 700;
      font-size: 24px;
      float: left;
    }

    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .logo-container {
      z-index: 2;
    }

    nav ul {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 0;
      margin: 0;
    }

    nav ul li {
      margin-left: 25px;
    }

    nav ul li a {
      color: #000;
      font-weight: 500;
      font-size: 14px;
      transition: color 0.3s;
    }

    nav ul li a.active {
      color: darkgoldenrod;
    }

    nav ul li a:hover {
      color: darkgoldenrod;
    }

    .cta-btn {
      background-color: darkgoldenrod;
      color: #000 !important;
      padding: 10px 20px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .cta-btn:hover {
      background-color: #b8860b;
    }

    .mobile-toggle {
      background: transparent;
      border: none;
      color: #000 !important;
      font-size: 24px;
      cursor: pointer;
      z-index: 1001;
      display: none;
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
    }

    footer {
      background-color: #111;
      color: #000;
      padding: 60px 0 20px;
    }

    .footer-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 40px;
      margin-bottom: 40px;
    }

    .footer-logo {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .footer-links h4,
    .footer-contact h4,
    .footer-social h4 {
      font-size: 1.2rem;
      margin-bottom: 20px;
      color: #ffffff;
    }

    .footer-links ul li {
      margin-bottom: 10px;
    }

    .footer-links ul li a {
      color: #ffffff;
      transition: color 0.3s;
    }

    .footer-links ul li a:hover {
      color: darkgoldenrod;
    }

    .footer-contact p {
      color: #ffffff;
      margin-bottom: 10px;
    }

    .social-icons {
      display: flex;
      gap: 15px;
    }

    .social-icons a {
      color: #ffffff;
      background-color: #333;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s;
    }

    .social-icons a:hover {
      background-color: darkgoldenrod;
    }

    .copyright {
      text-align: center;
      padding-top: 20px;
      border-top: 1px solid #333;
      color: #ffffff;
      font-size: 0.9rem;
    }

    .mobile-toggle {
      display: none;
      background: transparent;
      border: none;
      color: #000   #000 !important;
      font-size: 24px;
      cursor: pointer;
      z-index: 1000;
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logo-img {
      height: 50px;
      width: auto;
    }

    .app-name {
      font-size: 1.2rem;
      font-weight: 800;
      color: black;
      text-decoration: underline;
      text-decoration-color: darkgoldenrod;
      text-underline-offset: 5px;
      text-decoration-thickness: 2px;
    }

    @media (max-width: 768px) {
      header {
        position: relative;
        background-color: #fff;
        padding: 15px 0;
      }
      
      .logo {
        font-size: 20px;
      }
      
      nav {
        position: fixed;
        top: 0;
        left: auto;
        right: -250px;
        width: 250px;
        height: 100vh;
        background: rgba(255, 255, 255, 0.95);
        transform: none;
        transition: transform 0.3s ease;
        padding: 80px 30px 30px;
      }
      
      .mobile-toggle {
        display: block;
      }

      nav.active {
        display: block;
      }

      nav.active ul {
        display: flex;
        flex-direction: column;
        position: fixed;
        top: 0;
        right: 0;
        width: 250px;
        height: 100vh;
        background-color: rgba(255, 255, 255, 0.95);
        padding: 80px 30px 30px;
        align-items: flex-start;
        box-shadow: -5px 0 25px rgba(0,0,0,0.2);
        animation: slideIn 0.3s forwards;
      }

      nav ul li {
        margin: 15px 0;
      }

      nav ul li a {
        font-size: 16px;
      }
      nav.active {
        transform: translateX(-100%);
      }
    
      nav ul {
        flex-direction: column;
        gap: 20px;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }
    }

    /* Dashboard Specific Styles */
    .dashboard {
      padding: 120px 0 60px;
      background-color: #f8f9fa;
      min-height: 100vh;
    }

    .dashboard-header {
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }

    .dashboard-title {
      font-size: 2rem;
      font-weight: 700;
      color: #000;
      margin: 0;
    }

    .filter-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
    }

    .filter-group {
      flex: 1;
      min-width: 200px;
    }

    .filter-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 14px;
    }

    .filter-input {
      width: 100%;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: 'Poppins', sans-serif;
    }

    .filter-actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .filter-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .filter-btn.apply {
      background-color: darkgoldenrod;
      color: #000;
    }

    .filter-btn.reset {
      background-color: #f1f1f1;
      color: #333;
    }

    .filter-btn:hover {
      opacity: 0.9;
    }

   .applications-table {
      width: 100%;
      background: white;
      border-radius: 8px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      overflow: hidden;
      border: 1px solid darkgoldenrod;
    }

    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid rgba(184, 134, 11, 0.3);
      border-right: 1px solid rgba(184, 134, 11, 0.1);
    }

    th {
      background-color: #f8f6f0;
      font-weight: 600;
      position: sticky;
      top: 0;
      color: #333;
      border-bottom: 2px solid darkgoldenrod;
    }

    th:last-child, td:last-child {
      border-right: none;
    }

    tr:hover {
      background-color: rgba(184, 134, 11, 0.05);
    }


    .action-btn {
      padding: 8px 15px;
      border: none;
      border-radius: 4px;
      font-family: 'Poppins', sans-serif;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }

    .action-btn.view {
      background-color: darkgoldenrod;
      color: #000;
    }

    .action-btn.download {
      background-color: #333;
      color: white;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }


    .no-results {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 5px;
    }

    .page-btn {
      padding: 8px 12px;
      border: 1px solid #ddd;
      background: white;
      cursor: pointer;
      border-radius: 4px;
    }

    .page-btn.active {
      background-color: darkgoldenrod;
      color: white;
      border-color: darkgoldenrod;
    }

    .page-btn:hover:not(.active) {
      background-color: #f1f1f1;
    }

    /* Modal styles */
     .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }


    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 8px;
      width: 95%;
      height: 90vh;
      max-width: 1200px;
      padding: 20px;
      position: relative;
      transform: translateY(-20px);
      transition: transform 0.3s;
      display: flex;
      flex-direction: column;
      border: 2px solid darkgoldenrod;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }
  
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #666;
      transition: color 0.3s;
    }

    .modal-title {
      font-size: 1.5rem;
      color: #000;
      margin: 0;
    }

    .modal-close:hover {
      color: darkgoldenrod;
    }

    .transcript-container {
      flex: 1;
      width: 100%;
      border: 1px solid #eee;
      border-radius: 4px;
      overflow: hidden;
      background-color: #f9f9f9;
    }

    .transcript-iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    .transcript-unavailable {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      background-color: #f9f9f9;
      color: #666;
      font-size: 1.1rem;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      .dashboard {
        padding: 90px 0 40px;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }

      th, td {
        padding: 8px 10px;
        font-size: 14px;
      }

      .action-btn {
        padding: 4px 8px;
        font-size: 12px;
      }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        height: 85vh;
        padding: 15px;
      }
      
      th, td {
        padding: 10px;
      }
    }

    @media (max-width: 576px) {
      .action-btn {
        padding: 6px 10px;
        font-size: 12px;
      }
      
      .modal-content {
        width: 98%;
        height: 80vh;
      }
    }

    @media (max-width: 576px) {
      .filter-group {
        min-width: 100%;
      }

      .applications-table {
        display: block;
        overflow-x: auto;
      }

      .modal-content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div class="logo-container">
        <img src="assets/images/logo.png" alt="ECOWAS Logo" class="logo-img" style="max-height: 50px;">
        <span class="app-name">GRITLab Africa Bootcamp</span>
      </div>
    
      <button type="button" class="mobile-toggle"><i class="fa-solid fa-bars"></i></button>
      <nav>
        <ul>
          <li><a href="Home.html">Home</a></li>
          <li><a href="dashboard.html" class="active">Dashboard</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <section class="dashboard">
    <div class="container">
      <div class="dashboard-header">
        <h1 class="dashboard-title">Applications Dashboard</h1>
        <div>
          <button id="exportBtn" class="cta-btn">
            <i class="fas fa-download"></i> Export Data
          </button>
        </div>
      </div>

      <div class="filter-section">
        <div class="filter-row">
          <div class="filter-group">
            <label for="filterCountry" class="filter-label">Country</label>
            <select id="filterCountry" class="filter-input">
              <option value="">All Countries</option>
              <!-- Countries will be populated by JavaScript -->
            </select>
          </div>
          <div class="filter-group">
            <label for="filterCourse" class="filter-label">Course</label>
            <select id="filterCourse" class="filter-input">
              <option value="">All Courses</option>
              <!-- Courses will be populated by JavaScript -->
            </select>
          </div>
          <div class="filter-group">
            <label for="filterAverage" class="filter-label">Average Score</label>
            <select id="filterAverage" class="filter-input">
              <option value="">All Scores</option>
              <option value="90">90+</option>
              <option value="80">80+</option>
              <option value="70">70+</option>
              <option value="60">60+</option>
              <option value="50">50+</option>
              <option value="40">Below 50</option>
            </select>
          </div>
        </div>
        <div class="filter-actions">
          <button id="resetFilters" class="filter-btn reset">Reset Filters</button>
          <button id="applyFilters" class="filter-btn apply">Apply Filters</button>
        </div>
      </div>

      <div class="applications-table">
        <table>
          <thead>
            <tr>
              <th>First Name</th>
              <th>Last Name</th>
              <th>Email</th>
              <th>Country</th>
              <th>Course</th>
              <th>Average</th>
              <th>Date Applied</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="applicationsTableBody">
            <!-- Table rows will be populated by JavaScript -->
          </tbody>
        </table>
        <div id="noResults" class="no-results" style="display: none;">
          No applications found matching your criteria.
        </div>
      </div>

      <div class="pagination" id="pagination">
        <!-- Pagination will be populated by JavaScript -->
      </div>
    </div>
  </section>

  <!-- Transcript Modal -->
 <div class="modal-overlay" id="transcriptModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Transcript Viewer</h2>
        <button class="modal-close" id="closeModal">&times;</button>
      </div>
      <div id="transcriptContainer" class="transcript-container">
        <div id="transcriptContent"></div>
      </div>
    </div>
  </div>

  <footer id="contact">
    <div class="container">
      <div class="footer-content">
        <img src="assets/images/logo.png" alt="ECOWAS Logo" class="logo-img" style="max-height: 50px;">
        <div class="footer-links">
          <h4>Links</h4>
          <ul>
            <li><a href="Home.html">Home</a></li>
            <li><a href="Home.html#About">About</a></li>
            <li><a href="Apply.html">Apply</a></li>
            <li><a href="dashboard.html">Dashboard</a></li>
          </ul>
        </div>
        <div class="footer-contact">
          <h4>Contact</h4>
          <p>Email: jbs.innovation@uj.ac.za</p>
          <p>Phone: +27 63 155 2047</p>
        </div>
      </div>
      <div class="copyright">
        <p>© 2025 GRITLab Africa Bootcamp. All rights reserved.</p>
      </div>
    </div>
  </footer>

  <!-- Firebase and Dashboard Script -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { 
      getFirestore, 
      collection, 
      query, 
      where, 
      getDocs,
      orderBy 
    } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBVrk2_Uaao4IadkqdW_ZHAcqhKaHgfA7A",
      authDomain: "glabootcamp.firebaseapp.com",
      databaseURL: "https://glabootcamp-default-rtdb.firebaseio.com",
      projectId: "glabootcamp",
      storageBucket: "glabootcamp.appspot.com",
      messagingSenderId: "1019798214965",
      appId: "1:1019798214965:web:71815c385b7a4a9f0ed47c",
      measurementId: "G-JJ1Y2NSK96"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // DOM Elements
    const applicationsTableBody = document.getElementById('applicationsTableBody');
    const noResults = document.getElementById('noResults');
    const filterCountry = document.getElementById('filterCountry');
    const filterCourse = document.getElementById('filterCourse');
    const filterAverage = document.getElementById('filterAverage');
    const applyFilters = document.getElementById('applyFilters');
    const resetFilters = document.getElementById('resetFilters');
    const exportBtn = document.getElementById('exportBtn');
    const transcriptModal = document.getElementById('transcriptModal');
    const closeModal = document.getElementById('closeModal');
    const transcriptContent = document.getElementById('transcriptContent');
    const studentName = document.getElementById('studentName');
    const studentEmail = document.getElementById('studentEmail');
    const studentCourse = document.getElementById('studentCourse');
    const studentAverage = document.getElementById('studentAverage');
    const pagination = document.getElementById('pagination');

    // Global variables
    let allApplications = [];
    let filteredApplications = [];
    let currentPage = 1;
    const applicationsPerPage = 10;
    let countries = [];
    let courses = [];

    // List of African countries for the filter dropdown
    const africanCountries = [
      "Algeria", "Angola", "Benin", "Botswana", "Burkina Faso", "Burundi", 
      "Cabo Verde", "Cameroon", "Central African Republic", "Chad", "Comoros", 
      "Congo", "Côte d'Ivoire", "Djibouti", "Egypt", "Equatorial Guinea", 
      "Eritrea", "Eswatini", "Ethiopia", "Gabon", "Gambia", "Ghana", "Guinea", 
      "Guinea-Bissau", "Kenya", "Lesotho", "Liberia", "Libya", "Madagascar", 
      "Malawi", "Mali", "Mauritania", "Mauritius", "Morocco", "Mozambique", 
      "Namibia", "Niger", "Nigeria", "Rwanda", "Sao Tome and Principe", 
      "Senegal", "Seychelles", "Sierra Leone", "Somalia", "South Africa", 
      "South Sudan", "Sudan", "Tanzania", "Togo", "Tunisia", "Uganda", 
      "Zambia", "Zimbabwe"
    ];

    // Initialize the dashboard
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize mobile menu toggle
      initMobileMenu();
      
      // Load applications from Firebase
      loadApplications();
      
      // Set up event listeners
      applyFilters.addEventListener('click', applyFiltersHandler);
      resetFilters.addEventListener('click', resetFiltersHandler);
      exportBtn.addEventListener('click', exportData);
      closeModal.addEventListener('click', () => {
        transcriptModal.classList.remove('active');
      });
    });

    // Initialize mobile menu toggle
    function initMobileMenu() {
      const mobileToggle = document.querySelector('.mobile-toggle');
      const nav = document.querySelector('nav');
      
      if (mobileToggle) {
        mobileToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          nav.classList.toggle('active');
          
          const icon = this.querySelector('i');
          if (nav.classList.contains('active')) {
            icon.classList.remove('fa-bars');
            icon.classList.add('fa-times');
          } else {
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', function(e) {
          if (!nav.contains(e.target) && e.target !== mobileToggle && nav.classList.contains('active')) {
            nav.classList.remove('active');
            const icon = mobileToggle.querySelector('i');
            icon.classList.remove('fa-times');
            icon.classList.add('fa-bars');
          }
        });

        // Close menu when clicking on a nav link
        document.querySelectorAll('nav a').forEach(link => {
          link.addEventListener('click', function() {
            if (nav.classList.contains('active')) {
              nav.classList.remove('active');
              const icon = mobileToggle.querySelector('i');
              icon.classList.remove('fa-times');
              icon.classList.add('fa-bars');
            }
          });
        });
      }
    }

    // Load applications from Firebase
    async function loadApplications() {
      try {
        const q = query(collection(db, "bootcamp_applications"), orderBy("timestamp", "desc"));
        const querySnapshot = await getDocs(q);
        
        allApplications = [];
        countries = [];
        courses = [];
        
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          allApplications.push({
            id: doc.id,
            firstName: data.firstName || 'N/A',
            lastName: data.lastName || 'N/A',
            email: data.email || 'N/A',
            country: data.country || 'N/A',
            course: data.course || 'N/A',
            average: data.average || 'N/A',
            timestamp: data.timestamp ? data.timestamp.toDate() : new Date(),
            transcriptBase64: data.transcriptBase64 || ''
          });
          
          // Collect unique countries
          if (data.country && !countries.includes(data.country)) {
            countries.push(data.country);
          }
          
          // Collect unique courses
          if (data.course && !courses.includes(data.course)) {
            courses.push(data.course);
          }
        });
        
        // Sort countries and courses
        countries.sort();
        courses.sort();
        
        // Populate filter dropdowns
        populateFilterDropdowns();
        
        // Display all applications initially
        filteredApplications = [...allApplications];
        displayApplications();
        
      } catch (error) {
        console.error("Error loading applications:", error);
        alert("Failed to load applications. Please check console for details.");
      }
    }

    // Populate filter dropdowns with unique values
    function populateFilterDropdowns() {
      // Country filter
      filterCountry.innerHTML = '<option value="">All Countries</option>';
      countries.forEach(country => {
        filterCountry.innerHTML += `<option value="${country}">${country}</option>`;
      });
      
      // Add any African countries not in the data yet
      africanCountries.forEach(country => {
        if (!countries.includes(country)) {
          filterCountry.innerHTML += `<option value="${country}">${country}</option>`;
        }
      });
      
      // Course filter
      filterCourse.innerHTML = '<option value="">All Courses</option>';
      courses.forEach(course => {
        filterCourse.innerHTML += `<option value="${course}">${course}</option>`;
      });
    }

    // Apply filters based on user selection
    function applyFiltersHandler() {
      const countryFilter = filterCountry.value;
      const courseFilter = filterCourse.value;
      const averageFilter = filterAverage.value;
      
      filteredApplications = allApplications.filter(app => {
        // Country filter
        if (countryFilter && app.country !== countryFilter) return false;
        
        // Course filter
        if (courseFilter && app.course !== courseFilter) return false;
        
        // Average filter
        if (averageFilter) {
          const averageNum = parseFloat(app.average);
          if (isNaN(averageNum)) return false;
          
          if (averageFilter === "40" && averageNum >= 40) return false;
          if (averageFilter !== "40" && averageNum < parseFloat(averageFilter)) return false;
        }
        
        return true;
      });
      
      currentPage = 1;
      displayApplications();
    }

    // Reset all filters
    function resetFiltersHandler() {
      filterCountry.value = "";
      filterCourse.value = "";
      filterAverage.value = "";
      
      filteredApplications = [...allApplications];
      currentPage = 1;
      displayApplications();
    }

    // Display applications in the table with pagination
    function displayApplications() {
      if (filteredApplications.length === 0) {
        applicationsTableBody.innerHTML = '';
        noResults.style.display = 'block';
        pagination.innerHTML = '';
        return;
      }
      
      noResults.style.display = 'none';
      
      // Calculate pagination
      const totalPages = Math.ceil(filteredApplications.length / applicationsPerPage);
      const startIndex = (currentPage - 1) * applicationsPerPage;
      const endIndex = Math.min(startIndex + applicationsPerPage, filteredApplications.length);
      const paginatedApplications = filteredApplications.slice(startIndex, endIndex);
      
      // Clear table
      applicationsTableBody.innerHTML = '';
      
      // Populate table
      paginatedApplications.forEach(app => {
        const row = document.createElement('tr');
        
        // Format date
        const formattedDate = app.timestamp.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        row.innerHTML = `
          <td>${app.firstName}</td>
          <td>${app.lastName}</td>
          <td>${app.email}</td>
          <td>${app.country}</td>
          <td>${app.course}</td>
          <td>${app.average}</td>
          <td>${formattedDate}</td>
          <td>
            <button class="action-btn view" data-id="${app.id}" data-transcript="${app.transcriptBase64}">
              <i class="fas fa-eye"></i> View
            </button>
            ${app.transcriptBase64 && app.transcriptBase64 !== 'No transcript uploaded' ? 
              `<button class="action-btn download" data-id="${app.id}" data-transcript="${app.transcriptBase64}">
                <i class="fas fa-download"></i> Download
              </button>` : ''
            }
          </td>
        `;
        
        applicationsTableBody.appendChild(row);
      });
      
      // Set up event listeners for view/download buttons
      setupActionButtons();
      
      // Generate pagination
      generatePagination(totalPages);
    }

    // Set up event listeners for view/download buttons
    function setupActionButtons() {
      document.querySelectorAll('.action-btn.view').forEach(btn => {
        btn.addEventListener('click', function() {
          const appId = this.getAttribute('data-id');
          const transcriptBase64 = this.getAttribute('data-transcript');
          viewTranscript(appId, transcriptBase64);
        });
      });
      
      document.querySelectorAll('.action-btn.download').forEach(btn => {
        btn.addEventListener('click', function() {
          const appId = this.getAttribute('data-id');
          const transcriptBase64 = this.getAttribute('data-transcript');
          downloadTranscript(appId, transcriptBase64);
        });
      });
    }

    // View transcript in modal
    function viewTranscript(appId, transcriptBase64) {
      const application = filteredApplications.find(app => app.id === appId);
      
      if (!application) return;
      
      // Display transcript
      transcriptContent.innerHTML = '';
      
      if (transcriptBase64 && transcriptBase64 !== 'No transcript uploaded') {
        // Create iframe for PDF with maximum size
        const iframe = document.createElement('iframe');
        iframe.className = 'transcript-iframe';
        iframe.src = transcriptBase64;
        transcriptContent.appendChild(iframe);
      } else {
        // Show message if no transcript
        const message = document.createElement('div');
        message.className = 'transcript-unavailable';
        message.innerHTML = '<p>No transcript available for this application</p>';
        transcriptContent.appendChild(message);
      }
      
      // Show modal
      transcriptModal.classList.add('active');
      
      // Add escape key listener
      document.addEventListener('keydown', function escClose(e) {
        if (e.key === 'Escape') {
          transcriptModal.classList.remove('active');
          document.removeEventListener('keydown', escClose);
        }
      });
    }

    // Download transcript
    function downloadTranscript(appId, transcriptBase64) {
      const application = filteredApplications.find(app => app.id === appId);
      
      if (!application || !transcriptBase64 || transcriptBase64 === 'No transcript uploaded') {
        alert('No transcript available for download');
        return;
      }
      
      // Create a temporary link element
      const link = document.createElement('a');
      link.href = transcriptBase64;
      link.download = `transcript_${application.firstName}_${application.lastName}.pdf`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Generate pagination controls
    function generatePagination(totalPages) {
      pagination.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Previous button
      const prevBtn = document.createElement('button');
      prevBtn.className = 'page-btn';
      prevBtn.innerHTML = '&laquo;';
      prevBtn.disabled = currentPage === 1;
      prevBtn.addEventListener('click', () => {
        if (currentPage > 1) {
          currentPage--;
          displayApplications();
        }
      });
      pagination.appendChild(prevBtn);
      
      // Page buttons
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      // Adjust if we're at the end
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      // Always show first page
      if (startPage > 1) {
        const firstPageBtn = document.createElement('button');
        firstPageBtn.className = 'page-btn';
        firstPageBtn.textContent = '1';
        firstPageBtn.addEventListener('click', () => {
          currentPage = 1;
          displayApplications();
        });
        pagination.appendChild(firstPageBtn);
        
        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '8px 12px';
          pagination.appendChild(ellipsis);
        }
      }
      
      // Visible page buttons
      for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
        pageBtn.textContent = i;
        pageBtn.addEventListener('click', () => {
          currentPage = i;
          displayApplications();
        });
        pagination.appendChild(pageBtn);
      }
      
      // Always show last page
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '8px 12px';
          pagination.appendChild(ellipsis);
        }
        
        const lastPageBtn = document.createElement('button');
        lastPageBtn.className = 'page-btn';
        lastPageBtn.textContent = totalPages;
        lastPageBtn.addEventListener('click', () => {
          currentPage = totalPages;
          displayApplications();
        });
        pagination.appendChild(lastPageBtn);
      }
      
      // Next button
      const nextBtn = document.createElement('button');
      nextBtn.className = 'page-btn';
      nextBtn.innerHTML = '&raquo;';
      nextBtn.disabled = currentPage === totalPages;
      nextBtn.addEventListener('click', () => {
        if (currentPage < totalPages) {
          currentPage++;
          displayApplications();
        }
      });
      pagination.appendChild(nextBtn);
    }

    // Export data to CSV
    function exportData() {
      if (filteredApplications.length === 0) {
        alert('No data to export');
        return;
      }
      
      // Prepare CSV content
      let csvContent = "First Name,Last Name,Email,Country,Course,Average,Date Applied\n";
      
      filteredApplications.forEach(app => {
        const formattedDate = app.timestamp.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        csvContent += `"${app.firstName}","${app.lastName}","${app.email}","${app.country}","${app.course}","${app.average}","${formattedDate}"\n`;
      });
      
      // Create download link
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `gritlab_applications_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
</body>
</html>